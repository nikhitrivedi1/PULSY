<!DOCTYPE html>
<html>
<head>
    <title>AI Wearables Advisor</title>
    <link rel="stylesheet" href="chatPage.css">
    <style>
        body {
            font-family: "Aeonik", -apple-system, BlinkMacSystemFont, sans-serif;
            background: #E8E1D7;
            color: #1a1a1a;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #main-content {
            display: flex;
            flex-direction: column;
            margin-left: 20%;
            margin-top: 60px;
            min-height: calc(100vh - 60px);
            position: relative;
            width: 80%;
            height: 100%;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            width: 80%;
            height: 90%;
            margin: 0 auto;
            scroll-behavior: smooth;
        }

        .chat-container {
            width: 100%;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            min-height: 100%;
        }

        .message {
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            line-height: 1.6;
            font-size: 1rem;
            max-width: 85%;
            position: relative;
        }

        .user-message {
            background: #0B365B;
            color: #E8E1D7;
            margin-left: auto;
            margin-right: 0;
        }

        .assistant-message {
            background: #F5F1EB;
            color: #0B365B;
            margin-right: auto;
            margin-left: 0;
        }

        .input-area {
            position: fixed;
            bottom: 0;
            left: 20%;
            width: 80%;
            padding: 20px;
            background: #E8E1D7;
            border-top: 1px solid #D4CEC4;
            z-index: 100;
            display: flex;
            justify-content: center;
        }

        .query-container {
            width: 80%;
            max-width: 800px;
            margin: 0 auto;
        }

        .query-wrapper {
            display: flex;
            gap: 16px;
            background: #F5F1EB;
            border-radius: 30px;
            padding: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        }

        #queryInput {
            flex: 1;
            border: 2px solid #D4CEC4;
            border-radius: 20px;
            padding: 12px 20px;
            font-size: 1rem;
            resize: none;
            background: #F5F1EB;
            min-height: 24px;
        }

        #queryInput:focus {
            outline: none;
            border-color: #0B365B;
        }

        #sendQuery {
            padding: 12px 24px;
            border: none;
            border-radius: 20px;
            background: #0B365B;
            color: #E8E1D7;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        #sendQuery:hover {
            opacity: 0.9;
        }

        .metrics-container {
            position: fixed;
            left: 0;
            top: 60px;
            width: 20%;
            height: calc(100vh - 60px);
            background: #F5F1EB;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
            z-index: 200;
        }

        .metrics-header {
            margin-bottom: 20px;
        }

        .metrics-header h2 {
            margin: 0;
            color: #0B365B;
            font-size: 1.2rem;
        }

        .metrics-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .metric-block {
            background: white;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .metric-icon {
            width: 40px;
            height: 40px;
            background: #0B365B;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .metric-content h3 {
            margin: 0;
            font-size: 0.9rem;
            color: #666;
        }

        .metric-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: #0B365B;
            margin: 4px 0;
        }

        /* Devices sidebar section - horizontal card style */
        .devices-sidebar-section {
            margin-top: 2.2rem;
        }

        .devices-sidebar-title {
            font-size: 1.07rem;
            margin-bottom: 0.6rem;
            color: #0B365B;
            font-weight: 600;
            letter-spacing: 0.01em;
            text-align: center;
        }

        .devices-sidebar-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .device-sidebar-card-horizontal {
            width: 100%;
            min-height: 50px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px 0 rgba(34,52,89,0.06);
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 16px;
            padding: 9px 15px 9px 13px;
            position: relative;
            transition: box-shadow 0.18s;
        }

        .device-sidebar-card-horizontal:hover {
            box-shadow: 0 6px 22px rgba(22,50,100,0.12);
        }

        .sidebar-device-image-container {
            width: 36px;
            height: 36px;
            background: radial-gradient(circle at 65% 28%, #fff9, #d8e7fa 55%, #cee1f5 85%, #d5d9e6 100%);
            border-radius: 50%;
            border: 2px solid #eaf1fd;
            box-shadow: 0 1px 5px 0 #b7c6dd1a;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            flex-shrink: 0;
        }

        .sidebar-device-image {
            width: 23px;
            height: 23px;
            object-fit: contain;
            border-radius: 40% 60% 48% 52% / 52% 49% 57% 43%;
            filter: saturate(1.05);
        }

        .sidebar-status-dot {
            position: absolute;
            bottom: 3px;
            right: 4px;
            width: 9px;
            height: 9px;
            border-radius: 50%;
            box-shadow: 0 0 0 2px #fff;
        }
        .sidebar-status-pass {
            background: #34C759;
        }
        .sidebar-status-fail {
            background: #FF3B30;
        }

        .sidebar-device-info {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 0;
            justify-content: center;
        }

        .sidebar-device-name {
            font-size: 0.95rem;
            color: #0B365B;
            font-weight: 600;
            margin-bottom: 1px;
            margin-top: 1px;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .sidebar-device-status-label {
            font-size: 0.79rem;
            color: #7b7973;
            margin: 0 0 0 0;
            text-align: left;
        }
        .sidebar-reconnect-btn {
            margin-left: auto;
            margin-right: 6px;
            padding: 5px 12px;
            border-radius: 16px;
            border: 2px solid #FF3B30;
            background: #FF3B30;
            color: #fff;
            font-weight: 600;
            font-size: 0.83rem;
            cursor: pointer;
            transition: all 0.18s;
            letter-spacing: 0.01em;
            min-width: 70px;
            min-height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar-reconnect-btn:hover {
            background: #fff;
            color: #FF3B30;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .message {
            animation: fadeIn 0.3s ease;
        }

        .thinking-message {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* Feedback UI styles */
        .feedback-form-container {
            margin-top: 1em;
            padding-top: 0.5em;
            border-top: 1px solid #ece2cf;
            display: flex;
            flex-direction: column;
            gap: 0.65em;
        }
        .feedback-buttons {
            display: flex;
            gap: 1em;
            align-items: center;
            margin-bottom: 0.5em;
        }
        .feedback-btn {
            background: #F5F1EB;
            border: 1px solid #a9a7a1;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 1.35rem;
            color: #0B365B;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.1s, border-color 0.1s;
        }
        .feedback-btn.selected, .feedback-btn:active {
            background: #0B365B;
            color: #fff;
            border: 1px solid #0B365B;
        }
        .feedback-toolbar {
            display: flex;
            gap: 6px;
            margin-bottom: 4px;
            margin-top: 6px;
        }
        .toolbar-btn {
            background: #ecebe7;
            border: 1px solid #c6c2b7;
            border-radius: 6px;
            font-size: 1.08em;
            padding: 3px 8px;
            margin: 0 0.5px;
            cursor: pointer;
            color: #514b39;
        }
        .toolbar-btn.active,
        .toolbar-btn:focus {
            background: #0B365B;
            color: #fff;
            border-color: #0B365B;
        }

        .feedback-comment-input {
            width: 100%;
            min-height: 28px;
            border-radius: 8px;
            border: 1.2px solid #d4cec4;
            padding: 6px 11px;
            font-size: 1em;
            background: #fffdfa;
            box-sizing: border-box;
            margin-top: 0;
        }
        .feedback-submit-btn {
            margin-top: 0.5em;
            align-self: flex-end;
            background: #0B365B;
            color: #fff;
            border: none;
            border-radius: 12px;
            padding: 7px 20px;
            font-size: 1em;
            cursor: pointer;
            font-weight: 600;
        }
        .feedback-submit-btn:hover {
            background: #224877;
        }
        .feedback-sent-message {
            color: #27ae60;
            font-weight: 500;
            margin-left: 2px;
        }
        .feedback-error-message {
            color: #c92e22;
            font-weight: 500;
            margin-left: 2px;
            margin-top: 8px;
        }

        /* Toast notification styles for token refresh status */
        .toast-notification {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            z-index: 1000;
            animation: slideIn 0.3s ease, fadeOut 0.5s ease 4.5s forwards;
            max-width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .toast-success {
            background: #27ae60;
            color: white;
        }

        .toast-error {
            background: #c92e22;
            color: white;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; visibility: hidden; }
        }

        /* Reconnect button loading state */
        .sidebar-reconnect-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .sidebar-reconnect-btn.loading {
            position: relative;
        }

        .sidebar-reconnect-btn.loading::after {
            content: "";
            position: absolute;
            width: 12px;
            height: 12px;
            border: 2px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 6px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <%- include('partials_header.ejs') %>

    <!-- Toast notification for token refresh status -->
    <% if (typeof successMessage !== 'undefined' && successMessage) { %>
        <div class="toast-notification toast-success" id="toastNotification">
            <strong>Success!</strong> <%= successMessage %>
        </div>
    <% } else if (typeof errorMessage !== 'undefined' && errorMessage) { %>
        <div class="toast-notification toast-error" id="toastNotification">
            <strong>Error:</strong> <%= errorMessage %>
        </div>
    <% } %>

    <!-- Metrics Sidebar -->
    <div class="metrics-container">
        <div class="metrics-header">
            <h2>Your Metrics</h2>
        </div>
        <div class="metrics-grid">
            <% if (typeof user_metrics !== 'undefined' && user_metrics.length > 0) { %>
                <% for (const [metric_name, metric_data] of Object.entries(user_metrics[0])) { %>
                    <div class="metric-block">
                        <div class="metric-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="metric-content">
                            <h3><%= metric_name %></h3>
                            <div class="metric-value"><%= metric_data %></div>
                        </div>
                    </div>
                <% } %>
            <% } else { %>
                <div class="metric-block">
                    <div class="metric-content">
                        <% if (typeof errorMessage !== 'undefined' && errorMessage) { %>
                            <h3><%= errorMessage %></h3>
                        <% } else { %>
                            <h3>No metrics available</h3>
                        <% } %>
                    </div>
                </div>
            <% } %>
        </div>

        <!-- Devices Sidebar Section -->
        <div class="devices-sidebar-section">
            <div class="devices-sidebar-title">Your Devices</div>
            <div class="devices-sidebar-list">
                <% 
                    // user_devices format suggestion (for compatibility with your codebase)
                    // [
                    //   { device_type: "Oura Ring", device_status: "pass" }, { device_type: "Fitbit", device_status: "fail" }
                    // ]
                %>
                <% if (typeof user_devices !== "undefined" && user_devices && user_devices.length > 0) { %>
                    <% user_devices.forEach(function(device) { 
                        let type_key = (device.device_type || "").toLowerCase().replace(/\s/g, "_");
                        let status_class = (device.device_status === "pass") ? "sidebar-status-pass" : "sidebar-status-fail";
                        let status_label = (device.device_status === "pass") ? "Connected" : "Disconnected";
                        let imageSrc = "/assets/oura_ring.png";
                        if (type_key === "oura_ring") imageSrc = "/assets/oura_ring.png";
                        else if (type_key === "fitbit") imageSrc = "/assets/fitbit.png";
                        else if (type_key === "apple_watch") imageSrc = "/assets/apple_watch.png";
                        else imageSrc = "/assets/device_default.png";
                    %>
                        <div class="device-sidebar-card-horizontal">
                            <div class="sidebar-device-image-container">
                                <img src="<%= imageSrc %>" alt="<%= device.device_type %>" class="sidebar-device-image" />
                                <span class="sidebar-status-dot <%= status_class %>"></span>
                            </div>
                            <div class="sidebar-device-info">
                                <div class="sidebar-device-name"><%= device.device_type %></div>
                                <div class="sidebar-device-status-label"><%= status_label %></div>
                            </div>
                            <% if (device.device_status === "fail") { %>
                                <form method="POST" action="/chat/refresh_tokens" style="margin: 0;padding: 0;">
                                    <input type="hidden" name="device_type" value="<%= device.device_type %>">
                                    <input type="hidden" name="action" value="reconnect">
                                    <button type="submit" class="sidebar-reconnect-btn">
                                        Reconnect
                                    </button>
                                </form>
                            <% } %>
                        </div>
                    <% }); %>
                <% } else { %>
                    <div style="padding: 0.5em; color: #ababab; font-size: 0.9em; text-align: center;">
                        No devices connected yet.
                    </div>
                <% } %>
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div id="main-content">
        <!-- Chat History Container -->
        <div class="chat-history">
            <div class="chat-container" id="chatContainer">
                <!-- Initial greeting message -->
                <div class="message assistant-message">
                    Hello! I'm your AI wearables advisor. How can I help you optimize your device usage today?
                </div>
                
                <% if (typeof query_history !== 'undefined' && query_history.length > 0) { %>
                    <% for(let i = 0; i < query_history.length; i++) { %>
                        <!-- User query message -->
                        <div class="message user-message">
                            <%= query_history[i] %>
                        </div>
                        
                        <!-- Assistant response message if available -->
                        <% if (response_history[i]) { %>
                            <% 
                                // Determine if this is the last assistant message (where to attach feedback)
                                const isLastAssistantMessage = (i === response_history.length - 1);
                            %>
                            <div class="message assistant-message">
                                <%- response_history[i] %>
                                <% if (isLastAssistantMessage) { %>
                                <form class="feedback-form-container" id="feedbackForm" method="POST" action="/chat/feedback" autocomplete="off">
                                    <div class="feedback-buttons">
                                        <button type="button" class="feedback-btn" id="feedbackUp" data-value="up" aria-label="Thumbs Up">
                                            üëç
                                        </button>
                                        <button type="button" class="feedback-btn" id="feedbackDown" data-value="down" aria-label="Thumbs Down">
                                            üëé
                                        </button>
                                        <input type="hidden" name="feedback" id="feedbackValue" value="">
                                    </div>
                                    <!-- Text formatting toolbar -->
                                    <div class="feedback-toolbar" id="feedbackToolbar">
                                        <button type="button" class="toolbar-btn" data-cmd="bold" title="Bold"><b>B</b></button>
                                        <button type="button" class="toolbar-btn" data-cmd="italic" title="Italic"><i>I</i></button>
                                        <button type="button" class="toolbar-btn" data-cmd="underline" title="Underline"><u>U</u></button>
                                        <button type="button" class="toolbar-btn" data-cmd="ul" title="Bulleted List">&#8226;‚Ä¢&#8226;</button>
                                        <button type="button" class="toolbar-btn" data-cmd="ol" title="Numbered List">1.</button>
                                    </div>
                                    <!-- Contenteditable div for feedback comment, submitted as hidden textarea -->
                                    <div class="feedback-comment-input" id="feedbackCommentInput" contenteditable="true" spellcheck="true"
                                         style="min-height:38px; border:1.2px solid #d4cec4; border-radius:8px; padding:6px 11px; background:#fffdfa; box-sizing:border-box; resize:vertical;"
                                         placeholder="[Optional] Provide your preferred response to your query"></div>
                                    <textarea name="comment" id="feedbackCommentTextarea" style="display:none"></textarea>
                                    <button type="submit" class="feedback-submit-btn">Submit feedback</button>
                                </form>
                                <div class="feedback-sent-message" id="feedbackSentMsg" style="display: none;">Thank you for your feedback!</div>
                                <div class="feedback-error-message" id="feedbackErrorMsg" style="display: none;">There was an error submitting your feedback.</div>
                                <% } %>
                            </div>
                        <% } %>
                    <% } %>
                <% } %>
                <!-- Spacer to ensure last message is always visible above input -->
                <div id="chatSpacer" style="height: 250px;"></div>
            </div>
        </div>

        <!-- Query Input Area -->
        <div class="input-area">
            <form action="/chat/query" method="POST" class="query-container" id="asyncQueryForm">
                <div class="query-wrapper">
                    <textarea 
                        name="query"
                        id="queryInput" 
                        placeholder="Ask me about your wearable devices..."
                        rows="1"
                    ></textarea>
                    <button type="submit" id="sendQuery">
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </div>
                <div id="errorMessage" style="color:#c92e22; margin-top:6px; font-size:0.9em;"></div>
            </form>
        </div>
    </div>

    <script src="https://kit.fontawesome.com/your-font-awesome-kit.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatHistory = document.querySelector('.chat-history');
            if (chatHistory) {
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }

            // === TOAST NOTIFICATION HANDLING ===
            const toast = document.getElementById('toastNotification');
            if (toast) {
                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 5000);

                // Click to dismiss
                toast.addEventListener('click', () => {
                    toast.style.display = 'none';
                });
            }

            // === RECONNECT BUTTON HANDLING ===
            const reconnectForms = document.querySelectorAll('form[action="/chat/refresh_tokens"]');
            reconnectForms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    const btn = form.querySelector('.sidebar-reconnect-btn');
                    if (btn) {
                        btn.disabled = true;
                        btn.classList.add('loading');
                        btn.textContent = 'Reconnecting...';
                    }
                });
            });

            // === HELPER FUNCTIONS ===
            
            // Scroll to bottom of chat using the spacer element
            function scrollToBottom() {
                const spacer = document.getElementById('chatSpacer');
                if (spacer) {
                    // Use scrollIntoView for more reliable scrolling
                    requestAnimationFrame(() => {
                        spacer.scrollIntoView({ behavior: 'auto', block: 'end' });
                        console.log('Scrolled to spacer element');
                    });
                } else if (chatHistory) {
                    // Fallback to manual scroll
                    requestAnimationFrame(() => {
                        chatHistory.scrollTop = chatHistory.scrollHeight;
                        console.log('Fallback scroll to bottom');
                    });
                }
            }
            
            // Create feedback form HTML
            function createFeedbackFormHTML() {
                return `
                    <form class="feedback-form-container feedback-form-dynamic" method="POST" action="/chat/feedback" autocomplete="off">
                        <div class="feedback-buttons">
                            <button type="button" class="feedback-btn" data-value="up" aria-label="Thumbs Up">üëç</button>
                            <button type="button" class="feedback-btn" data-value="down" aria-label="Thumbs Down">üëé</button>
                            <input type="hidden" name="feedback" class="feedbackValue" value="">
                        </div>
                        <div class="feedback-toolbar">
                            <button type="button" class="toolbar-btn" data-cmd="bold" title="Bold"><b>B</b></button>
                            <button type="button" class="toolbar-btn" data-cmd="italic" title="Italic"><i>I</i></button>
                            <button type="button" class="toolbar-btn" data-cmd="underline" title="Underline"><u>U</u></button>
                            <button type="button" class="toolbar-btn" data-cmd="ul" title="Bulleted List">&#8226;‚Ä¢&#8226;</button>
                            <button type="button" class="toolbar-btn" data-cmd="ol" title="Numbered List">1.</button>
                        </div>
                        <div class="feedback-comment-input" contenteditable="true" spellcheck="true"
                             style="min-height:38px; border:1.2px solid #d4cec4; border-radius:8px; padding:6px 11px; background:#fffdfa; box-sizing:border-box;"
                             placeholder="[Optional] Provide your preferred response to your query"></div>
                        <textarea name="comment" class="feedbackCommentTextarea" style="display:none"></textarea>
                        <button type="submit" class="feedback-submit-btn">Submit feedback</button>
                    </form>
                    <div class="feedback-sent-message" style="display: none;">Thank you for your feedback!</div>
                    <div class="feedback-error-message" style="display: none;">There was an error submitting your feedback.</div>
                `;
            }

            // Initialize feedback form handlers
            function initializeFeedbackForm(container) {
                const feedbackForm = container.querySelector('.feedback-form-dynamic');
                if (!feedbackForm) return;

                const btnUp = feedbackForm.querySelector('[data-value="up"]');
                const btnDown = feedbackForm.querySelector('[data-value="down"]');
                const feedbackValue = feedbackForm.querySelector('.feedbackValue');
                const sentMsg = container.querySelector('.feedback-sent-message');
                const errorMsg = container.querySelector('.feedback-error-message');
                const formattingToolbar = feedbackForm.querySelector('.feedback-toolbar');
                const editableDiv = feedbackForm.querySelector('.feedback-comment-input');
                const textareaBackup = feedbackForm.querySelector('.feedbackCommentTextarea');

                function selectFeedback(val) {
                    btnUp.classList.remove('selected');
                    btnDown.classList.remove('selected');
                    if (val === 'up') {
                        btnUp.classList.add('selected');
                        feedbackValue.value = 'up';
                    } else if (val === 'down') {
                        btnDown.classList.add('selected');
                        feedbackValue.value = 'down';
                    }
                }

                btnUp.addEventListener('click', (e) => { e.preventDefault(); selectFeedback('up'); });
                btnDown.addEventListener('click', (e) => { e.preventDefault(); selectFeedback('down'); });

                // Text formatting
                if (formattingToolbar && editableDiv) {
                    formattingToolbar.addEventListener('click', (e) => {
                        const btn = e.target.closest('.toolbar-btn');
                        if (!btn) return;
                        e.preventDefault();
                        const cmd = btn.getAttribute('data-cmd');
                        editableDiv.focus();
                        if (cmd === "bold") document.execCommand('bold');
                        else if (cmd === "italic") document.execCommand('italic');
                        else if (cmd === "underline") document.execCommand('underline');
                        else if (cmd === "ul") document.execCommand('insertUnorderedList');
                        else if (cmd === "ol") document.execCommand('insertOrderedList');
                    });

                    editableDiv.addEventListener('keydown', (event) => {
                        if (event.key === 'Enter' && !event.shiftKey) event.preventDefault();
                    });
                }

                // Paste filtering
                editableDiv && editableDiv.addEventListener('paste', (e) => {
                    e.preventDefault();
                    let text = (e.clipboardData || window.clipboardData).getData('text/plain');
                    document.execCommand('insertText', false, text);
                });

                // Form submit
                feedbackForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    if (!feedbackValue.value) {
                        btnUp.classList.add('selected');
                        btnDown.classList.add('selected');
                        setTimeout(() => {
                            btnUp.classList.remove('selected');
                            btnDown.classList.remove('selected');
                        }, 300);
                        return;
                    }

                    if (textareaBackup && editableDiv) {
                        textareaBackup.value = editableDiv.innerHTML;
                    }

                    const feedbackData = {
                        feedback: feedbackValue.value,
                        comment: editableDiv ? editableDiv.innerHTML : ''
                    };

                    feedbackForm.querySelectorAll('button, textarea, input, [contenteditable]').forEach((el) => {
                        el.disabled = true;
                        if (el.getAttribute && el.getAttribute('contenteditable') === "true") {
                            el.setAttribute('contenteditable', 'false');
                        }
                    });

                    if (errorMsg) errorMsg.style.display = 'none';

                    try {
                        const res = await fetch('/chat/feedback', {
                            method: 'POST',
                            body: JSON.stringify(feedbackData),
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            }
                        });

                        const data = await res.json().catch(() => ({success: true}));
                        
                        if (res.ok) {
                            feedbackForm.style.display = "none";
                            if (sentMsg) sentMsg.style.display = "block";
                            if (errorMsg) errorMsg.style.display = "none";
                        } else {
                            throw new Error("Server error");
                        }
                    } catch (err) {
                        feedbackForm.style.display = "none";
                        if (sentMsg) sentMsg.style.display = "none";
                        if (errorMsg) {
                            errorMsg.style.display = "block";
                            errorMsg.textContent = "There was an error submitting your feedback.";
                        }
                    }
                });
            }

            // === ASYNC QUERY HANDLING ===
            const queryForm = document.getElementById('asyncQueryForm');
            const chatContainer = document.getElementById('chatContainer');
            const queryInput = document.getElementById('queryInput');
            const sendBtn = document.getElementById('sendQuery');
            const errorDiv = document.getElementById('errorMessage');

            if (queryForm && chatContainer && queryInput) {
                queryForm.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    // Clear any previous errors
                    if (errorDiv) errorDiv.textContent = "";
                    
                    const userQuery = queryInput.value.trim();
                    if (!userQuery) {
                        if (errorDiv) errorDiv.textContent = "Please enter a query.";
                        queryInput.focus();
                        return;
                    }

                    // Add user's message to chat (insert before spacer)
                    const spacer = document.getElementById('chatSpacer');
                    const userMsg = document.createElement('div');
                    userMsg.className = 'message user-message';
                    userMsg.textContent = userQuery;
                    if (spacer) {
                        chatContainer.insertBefore(userMsg, spacer);
                    } else {
                        chatContainer.appendChild(userMsg);
                    }
                    scrollToBottom();

                    // Show "Thinking..." message with pulsing animation
                    const assistantMsg = document.createElement('div');
                    assistantMsg.className = 'message assistant-message thinking-message';
                    assistantMsg.id = 'pending-assistant-msg';
                    assistantMsg.innerHTML = '<em style="color:#666;">ü§î Thinking...</em>';
                    if (spacer) {
                        chatContainer.insertBefore(assistantMsg, spacer);
                    } else {
                        chatContainer.appendChild(assistantMsg);
                    }

                    // Scroll to bottom
                    scrollToBottom();

                    // Disable input while processing
                    sendBtn.disabled = true;
                    queryInput.disabled = true;

                    try {
                        const res = await fetch('/chat/query', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify({ query: userQuery })
                        });

                        const data = await res.json();

                        // Remove "Thinking..." message
                        assistantMsg.remove();

                        // Check for errors
                        if (!res.ok || (data.success === false)) {
                            const errorMessage = data.error || data.message || 'Server error occurred';
                            if (errorDiv) errorDiv.textContent = errorMessage;
                            return;
                        }

                        // Get the response
                        let assistantResponse = data.response || '';
                        
                        if (!assistantResponse) {
                            assistantResponse = 'Sorry, I did not understand. Please try again.';
                        }

                        // Create assistant message element with feedback form (insert before spacer)
                        const assistantMsgEl = document.createElement('div');
                        assistantMsgEl.className = 'message assistant-message';
                        assistantMsgEl.innerHTML = assistantResponse + createFeedbackFormHTML();
                        if (spacer) {
                            chatContainer.insertBefore(assistantMsgEl, spacer);
                        } else {
                            chatContainer.appendChild(assistantMsgEl);
                        }

                        // Initialize feedback handlers for the new form
                        initializeFeedbackForm(assistantMsgEl);

                        // Scroll to bottom after rendering completes
                        scrollToBottom();
                        setTimeout(scrollToBottom, 100);

                    } catch(err) {
                        console.error('Query submission error:', err);
                        if (assistantMsg.parentNode) assistantMsg.remove();
                        if (errorDiv) errorDiv.textContent = "Network error: " + err.message;
                    } finally {
                        // Re-enable input
                        sendBtn.disabled = false;
                        queryInput.disabled = false;
                        queryInput.value = "";
                        queryInput.focus();
                    }
                });
            }

            // === FEEDBACK UI INTERACTIVITY ===
            const feedbackForm = document.getElementById('feedbackForm');
            if (feedbackForm) {
                const btnUp = document.getElementById('feedbackUp');
                const btnDown = document.getElementById('feedbackDown');
                const feedbackValue = document.getElementById('feedbackValue');
                const sentMsg = document.getElementById('feedbackSentMsg');
                const errorMsg = document.getElementById('feedbackErrorMsg');
                const formattingToolbar = document.getElementById('feedbackToolbar');
                const editableDiv = document.getElementById('feedbackCommentInput');
                const textareaBackup = document.getElementById('feedbackCommentTextarea');

                // Handler for button selection
                function selectFeedback(val) {
                    if (!btnUp || !btnDown) return;
                    btnUp.classList.remove('selected');
                    btnDown.classList.remove('selected');
                    if (val === 'up') {
                        btnUp.classList.add('selected');
                        feedbackValue.value = 'up';
                    } else if (val === 'down') {
                        btnDown.classList.add('selected');
                        feedbackValue.value = 'down';
                    }
                }

                btnUp && btnUp.addEventListener('click', function(e) {
                    e.preventDefault();
                    selectFeedback('up');
                });
                btnDown && btnDown.addEventListener('click', function(e) {
                    e.preventDefault();
                    selectFeedback('down');
                });

                // Text formatting in feedback
                if (formattingToolbar && editableDiv) {
                    formattingToolbar.addEventListener('click', function(e) {
                        const btn = e.target.closest('.toolbar-btn');
                        if (!btn) return;
                        e.preventDefault();
                        const cmd = btn.getAttribute('data-cmd');
                        editableDiv.focus();
                        if (cmd === "bold") {
                            document.execCommand('bold');
                        } else if (cmd === "italic") {
                            document.execCommand('italic');
                        } else if (cmd === "underline") {
                            document.execCommand('underline');
                        } else if (cmd === "ul") {
                            document.execCommand('insertUnorderedList');
                        } else if (cmd === "ol") {
                            document.execCommand('insertOrderedList');
                        }
                    });

                    // Keyboard submit: prevent form submission with Enter key in the editable div
                    editableDiv.addEventListener('keydown', function(event) {
                        if (event.key === 'Enter' && !event.shiftKey) {
                            // allow newline with shift+enter, otherwise prevent
                            event.preventDefault();
                        }
                    });
                }

                // Placeholder handling for contenteditable (if empty)
                function showPlaceholder() {
                    if (editableDiv.innerText.trim() === "" && editableDiv.childNodes.length === 0) {
                        editableDiv.innerHTML = '';
                        editableDiv.setAttribute('data-placeholder-shown', 'true');
                    }
                }
                editableDiv && editableDiv.addEventListener('focus', function() {
                    editableDiv.setAttribute('data-placeholder-shown', 'false');
                });
                editableDiv && editableDiv.addEventListener('blur', showPlaceholder);

                // Basic paste filtering
                editableDiv && editableDiv.addEventListener('paste', function(e){
                    e.preventDefault();
                    let text = (e.clipboardData || window.clipboardData).getData('text/plain');
                    document.execCommand('insertText', false, text);
                });

                // -- AJAX Feedback Submit
                feedbackForm.addEventListener('submit', function(e) {
                    e.preventDefault();

                    if (!feedbackValue.value) {
                        // highlight if no feedback selected
                        if (btnUp) btnUp.classList.add('selected');
                        if (btnDown) btnDown.classList.add('selected');
                        setTimeout(function() {
                            btnUp && btnUp.classList.remove('selected');
                            btnDown && btnDown.classList.remove('selected');
                        }, 300);
                        return false;
                    }
                    if (textareaBackup && editableDiv) {
                        textareaBackup.value = editableDiv.innerHTML;
                    }

                    // Build form data as JSON object instead of FormData
                    const feedbackData = {
                        feedback: feedbackValue.value,
                        comment: editableDiv ? editableDiv.innerHTML : ''
                    };

                    // Disable UI controls while submitting
                    feedbackForm.querySelectorAll('button, textarea, input, [contenteditable]').forEach(function(el) {
                        el.disabled = true;
                        if (el.getAttribute && el.getAttribute('contenteditable') === "true") {
                            el.setAttribute('contenteditable', 'false');
                        }
                    });

                    // Hide error on new submit
                    if (errorMsg) errorMsg.style.display = 'none';

                    // Send AJAX request with JSON body
                    fetch(feedbackForm.action, {
                        method: 'POST',
                        body: JSON.stringify(feedbackData),
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        }
                    })
                    .then(function(res) {
                        // Accept 200 or 201
                        if (res.ok) return res.json().catch(()=>({success:true}));
                        throw new Error("Server error");
                    })
                    .then(function(data) {
                        // Remove form & display thank you
                        if (feedbackForm) feedbackForm.style.display = "none";
                        if (sentMsg) sentMsg.style.display = "block";
                        if (errorMsg) errorMsg.style.display = "none";
                    })
                    .catch(function(err) {
                        // Remove form & display error message
                        if (feedbackForm) feedbackForm.style.display = "none";
                        if (sentMsg) sentMsg.style.display = "none";
                        if (errorMsg) {
                            errorMsg.style.display = "block";
                            errorMsg.textContent = "There was an error submitting your feedback.";
                        }
                    });

                    return false;
                });
            }
        });
    </script>
</body>
</html>
